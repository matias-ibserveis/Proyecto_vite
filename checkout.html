<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - LURÁ</title>
  <link rel="stylesheet" href="/src/styleKHURT.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
</head>
<body>
  <div id="navbar"></div>
  <div class="cart-container-wrapper">
    <div id="cart-header"></div>
    <div class="cart-container">
      <table class="cart-table">
        <thead>
          <tr style="display: flex; width: 100%;">
            <th class="caption-with-letter-spacing product-column" colspan="2" scope="col">Productos</th>
            <th class="quantity-column" scope="col">Cantidad</th>
            <th class="small-right caption-with-letter-spacing total-column" scope="col">Total</th>
          </tr>
        </thead>
        <tbody id="cart-body"></tbody>
      </table>
    </div>
<div class="checkout-footer">
  <div class="special-instructions">
    <label for="order-instructions2" class="instructions-label">Instrucción Especial:</label>
    <textarea id="order-instructions2" rows="3" placeholder="Introduzca algun comentario si desea realizar algún tipo de especificación. (Opcional)"></textarea>
  </div>
  <div class="special-instructions">
    <label for="order-instructions" class="instructions-label">Nombre:</label>
    <textarea id="order-instructions" rows="4" placeholder="Escriba un Nombre con un mínimo de 4 caracteres que pueda ser Reconocible su Pedido.  (Obligatorio)"></textarea>
  </div>
</div>

<div class="special-instructions" style="max-width:400px; margin:0 auto;">
  <label for="opcion-especial" class="instructions-label">¿Dónde desea recoger su Cesta?</label>
  <select id="opcion-especial" required>
    <option value="" disabled selected>Elija un sitio donde desea recoger la Cesta. (Obligatorio)</option>
    <option value="opcion1">Recoger en la Tienda</option>
    <option value="opcion2">Colegio Mata de Jonc</option>
    <option value="opcion3">Colegio Nau</option>
    <option value="opcion4">Colegio Molins</option>
  </select>
</div>

<div id="confirm-popup" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:12px; padding:32px 24px; max-width:320px; margin:auto; text-align:center; box-shadow:0 4px 24px rgba(0,0,0,0.15);">
    <h2 style="margin-bottom:24px;">¿Segura/o?</h2>
    <button id="popup-si" style="width:50px; height:50px; background:#a3e0a5; color:#fff; border:none; border-radius:8px; font-size:1.3rem; font-weight:bold; margin-right:16px; cursor:pointer; transition:background 0.2s;">Sí</button>
    <button id="popup-no" style="width:50px; height:50px; background:#ffb3b1; color:#fff; border:none; border-radius:8px; font-size:1.3rem; font-weight:bold; cursor:pointer; transition:background 0.2s;">No</button>
  </div>
</div>



  <div class="subtotal-float">
    <h3 class="subtotal-text">Subtotal: <span id="subtotal-amount">€0.00</span></h3>
    <button class="checkout-btn">FINALIZAR <br>PEDIDO</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script type="module">
    import { CheckoutNavbar } from '/src/components/CheckoutNavbar.js';
    import { CartHeader } from '/src/components/CartHeader.js';


    // Render components
    const navbar = document.getElementById('navbar');
    const cartHeader = document.getElementById('cart-header');
    const popupContainer = document.getElementById('checkout-popup-container');
    if (navbar) {
      navbar.appendChild(CheckoutNavbar());
    }
    if (cartHeader) {
      cartHeader.appendChild(CartHeader());
    }


    // Calculate subtotal
function calculateSubtotal(cart) {
  return cart.reduce((total, item) => {
    // Si es cesta, suma su precio * cantidad, si no, igual
    const itemTotal = item.type === 'cesta'
      ? (item.price * (item.quantity || 1))
      : (item.quantity * item.price);
    return total + itemTotal;
  }, 0).toFixed(2);
}

    // Render subtotal
    function renderSubtotal() {
      const subtotalAmount = document.getElementById('subtotal-amount');
      if (subtotalAmount) {
        const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
        const subtotal = calculateSubtotal(cart);
        subtotalAmount.textContent = `€${subtotal}`;
      }
    }

    // Render cart items
    function renderCheckoutCart() {
      const cartBody = document.getElementById('cart-body');
      if (!cartBody) return;

      const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
      cartBody.innerHTML = '';

      if (cart.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
          <td colspan="4" style="text-align: center; padding: 1rem; color: var(--secondary-color);">
            Su Carro no es Saludable para Nosotras ;).
          </td>
        `;
        cartBody.appendChild(emptyRow);
      } else {
        cart.forEach((item, index) => {
          const row = document.createElement('tr');
          row.className = 'cart-item-row';
          row.dataset.index = index;
let imageUrl = "/images/logo1.png";
if (
  producto.imagen1 &&
  producto.imagen1 !== "null" &&
  producto.imagen1 !== "(Null)" &&
  producto.imagen1 !== null
) {
  if (producto.imagen1.includes("drive.google.com")) {
    const driveRegex = /\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)/;
    const match = producto.imagen1.match(driveRegex);
    if (match && (match[1] || match[2])) {
      imageUrl = `https://drive.google.com/thumbnail?id=${match[1] || match[2]}&sz=w800-h600`;
    } else {
      imageUrl = producto.imagen1;
    }
  } else {
    imageUrl = producto.imagen1;
  }
}

          let productDetails = '';
          if (item.type === 'cesta') {
            const ingredientsList = item.ingredients.map(ing =>
              `${ing.name}: ${ing.quantity}`
            ).join('<br>');
            productDetails = `
              <div class="cart-item-details">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-ingredients">${ingredientsList}</div>
              </div>
            `;
          } else {
            productDetails = `
              <div class="cart-item-details">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">€${item.price.toFixed(2)}</div>
              </div>
            `;
          }

          const total = ((item.quantity || 1) * item.price).toFixed(2);
          row.innerHTML = `
            <td class="cart-item-image-cell">
              <img src="${imageUrl}" alt="${item.name}" class="cart-item-image" onerror="this.src='/images/logo.png'" />
            </td>
            <td class="cart-item-details-cell">${productDetails}</td>
            <td class="cart-item-quantity-total-cell">
              <div class="quantity-total-container">
                <div class="quantity-control">
                  <button class="quantity-btn decrease" data-index="${index}">-</button>
                  <span class="quantity-display">${item.quantity}</span>
                  <button class="quantity-btn increase" data-index="${index}">+</button>
                </div>
                <span class="cart-item-total">€${total}</span>
              </div>
            </td>
            <td class="cart-item-remove-cell">
              <button class="remove-btn" data-index="${index}">✕</button>
            </td>
          `;
          cartBody.appendChild(row);
        });

        cartBody.querySelectorAll('.quantity-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
            const item = cart[index];

            if (e.target.classList.contains('increase')) {
              item.quantity += 1;
            } else if (e.target.classList.contains('decrease')) {
              if (item.quantity > 1) {
                item.quantity -= 1;
              }
            }

            sessionStorage.setItem('cart', JSON.stringify(cart));
            renderCheckoutCart();
            renderSubtotal();
          });
        });

        cartBody.querySelectorAll('.remove-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
            cart.splice(index, 1);
            sessionStorage.setItem('cart', JSON.stringify(cart));
            renderCheckoutCart();
            renderSubtotal();
          });
        });
      }

      renderSubtotal();
    }

    // Handle special instructions
    function renderSpecialInstructions() {
      const instructionsTextarea = document.getElementById('order-instructions');
      if (instructionsTextarea) {
        const savedInstructions = sessionStorage.getItem('orderInstructions') || '';
        instructionsTextarea.value = savedInstructions;

        instructionsTextarea.addEventListener('input', () => {
          const instructions = instructionsTextarea.value.trim();
          if (instructions) {
            sessionStorage.setItem('orderInstructions', instructions);
          } else {
            sessionStorage.removeItem('orderInstructions');
          }
        });
      }
    }


    // Initial render
    renderCheckoutCart();
    renderSpecialInstructions();
    setupCheckoutButton();

    // Re-render on storage changes
    window.addEventListener('storage', (e) => {
      if (e.key === 'cart' || e.key === 'orderInstructions') {
        renderCheckoutCart();
        renderSpecialInstructions();
      }
    });
  </script>





<script>
  // Mostrar el popup al pulsar FINALIZAR PEDIDO
  document.querySelector('.checkout-btn').addEventListener('click', function(e) {
    e.preventDefault();
    const nombre = document.getElementById('order-instructions').value.trim();
    const select = document.getElementById('opcion-especial');
    const selectedValue = select.value;

    let valid = true;

    // Validación del nombre
    if (!nombre || nombre.replace(/\s/g, '').length < 4) {
      document.getElementById('order-instructions').style.backgroundColor = '#ffc8c8';
      document.getElementById('order-instructions').style.boxShadow = '';
      valid = false;
    } else {
      document.getElementById('order-instructions').style.backgroundColor = '#a3e0a5';
      document.getElementById('order-instructions').style.boxShadow = '0 0 0 2px #4CAF5077';
    }

    // Validación del selector
    if (!selectedValue) {
      select.style.backgroundColor = '#ffc8c8';
      select.style.boxShadow = '';
      valid = false;
    } else {
      select.style.backgroundColor = '#a3e0a5';
      select.style.boxShadow = '0 0 0 2px #4CAF5077';
    }

    if (!valid) {
      alert('Por favor, escribe tu nombre con un mínimo de 4 caracteres y elige una opción de recogida para finalizar el pedido.');
      return;
    }

    document.getElementById('confirm-popup').style.display = 'flex';
  });

  // Botón NO: cierra el popup
  document.getElementById('popup-no').addEventListener('click', function() {
    document.getElementById('confirm-popup').style.display = 'none';
  });

  // Botón SÍ: cierra el popup (aquí puedes poner la acción que quieras en el futuro)
  document.getElementById('popup-si').addEventListener('click', function() {
    document.getElementById('confirm-popup').style.display = 'none';
    // Aquí puedes poner la acción para "Sí" en el futuro
  });

  // Validación en tiempo real para el nombre
  const instrucciones1 = document.getElementById('order-instructions');
  instrucciones1.addEventListener('input', function() {
    const letras = this.value.replace(/\s/g, '');
    if (letras.length >= 4) {
      this.style.backgroundColor = '#a3e0a5';
      this.style.boxShadow = '0 0 0 2px #4CAF5077';
    } else {
      this.style.backgroundColor = '#ffc8c8';
      this.style.boxShadow = '';
    }
  });

  // Validación en tiempo real para el selector
  const select = document.getElementById('opcion-especial');
  select.addEventListener('change', function() {
    if (this.value) {
      this.style.backgroundColor = '#a3e0a5';
      this.style.boxShadow = '0 0 0 2px #4CAF5077';
    } else {
      this.style.backgroundColor = '#ffc8c8';
      this.style.boxShadow = '';
    }
  });
</script>
<div style="height: 250px; width: 100%;"></div>


</body>
</html>