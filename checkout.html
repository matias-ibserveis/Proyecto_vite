<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - LURÁ</title>
  <link rel="stylesheet" href="/src/style.css" />
  <!-- Add Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
  <div id="navbar"></div>
  <div class="cart-container-wrapper">
    <div id="cart-header"></div>
    <div class="cart-container">
      <table class="cart-table">
        <thead>
          <tr style="display: flex; width: 100%;">
            <th class="caption-with-letter-spacing product-column" colspan="2" scope="col">Product</th>
            <th class="quantity-column" scope="col">Quantity</th>
            <th class="small-right caption-with-letter-spacing total-column" scope="col">Total</th>
          </tr>
        </thead>
        <tbody id="cart-body"></tbody>
      </table>
    </div>
    <!-- Checkout Footer with Special Instructions and Subtotal -->
    <div class="checkout-footer">
      <div class="special-instructions">
        <label for="order-instructions" class="instructions-label">Special Instructions:</label>
        <textarea id="order-instructions" rows="3" placeholder="Enter any special instructions (e.g., delivery notes, preferences)"></textarea>
      </div>
      <div class="subtotal-section">
        <h3 class="subtotal-text">Subtotal: <span id="subtotal-amount">€0.00</span></h3>
        <button class="checkout-btn">Checkout</button>
      </div>
    </div>
  </div>
  <!-- Checkout Popup -->
  <div id="checkout-popup" class="checkout-popup">
    <div class="checkout-popup-content">
      <span class="checkout-popup-close">×</span>
      <h2 class="checkout-popup-title">Contacto</h2>
    </div>
  </div>
  <!-- Add Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script type="module" src="/src/main.js"></script>
  <!-- Add this script block after the #cart-header div -->
  <script type="module">
    import { CestaNavbar } from '/src/components/CestaNavbar.js';
    import { CartHeader } from '/src/components/CartHeader.js';
    const navbar = document.getElementById('navbar');
    const cartHeader = document.getElementById('cart-header');
    if (navbar) {
      navbar.appendChild(CestaNavbar());
    }
    if (cartHeader) {
      cartHeader.appendChild(CartHeader());
    }

    // Function to calculate subtotal
    function calculateSubtotal(cart) {
      return cart.reduce((total, item) => {
        const itemTotal = item.type === 'cesta' ? 0 : (item.quantity * item.price);
        return total + itemTotal;
      }, 0).toFixed(2);
    }

    // Function to render subtotal
    function renderSubtotal() {
      const subtotalAmount = document.getElementById('subtotal-amount');
      if (subtotalAmount) {
        const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
        const subtotal = calculateSubtotal(cart);
        subtotalAmount.textContent = `€${subtotal}`;
      }
    }

    // Function to render cart items in the checkout table
    function renderCheckoutCart() {
      const cartBody = document.getElementById('cart-body');
      if (!cartBody) return;

      const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
      cartBody.innerHTML = ''; // Clear existing rows

      if (cart.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
          <td colspan="4" style="text-align: center; padding: 1rem; color: var(--secondary-color);">
            Your cart is empty.
          </td>
        `;
        cartBody.appendChild(emptyRow);
      } else {
        cart.forEach((item, index) => {
          const row = document.createElement('tr');
          row.className = 'cart-item-row'; // <-- FIXED: assignment, not just value
          row.dataset.index = index; // Store index for updates

          let imageUrl = '/images/logo.png'; // Default image
          if (item.type === 'product' && item.imagen1) {
            imageUrl = item.imagen1;
            // Convert Google Drive URL to thumbnail if applicable
            if (imageUrl.includes('drive.google.com')) {
              const driveRegex = /\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)/;
              const match = imageUrl.match(driveRegex); // <-- FIXED: match on imageUrl, not driveRegex
              if (match && (match[1] || match[2])) {
                imageUrl = `https://drive.google.com/thumbnail?id=${match[1] || match[2]}&sz=w100-h100`;
              }
            }
          }

          let productDetails = '';
          if (item.type === 'cesta') {
            // Display cesta name and ingredients
            const ingredientsList = item.ingredients.map(ing =>
              `${ing.name}: ${ing.selected} (from ${ing.place}, by ${ing.supplier})`
            ).join('<br>');
            productDetails = `
              <div class="cart-item-details">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-ingredients">${ingredientsList}</div>
              </div>
            `;
          } else {
            // Display product name and price
            productDetails = `
              <div class="cart-item-details">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">€${item.price.toFixed(2)}</div>
              </div>
            `;
          }

          const total = item.type === 'cesta' ? 0 : (item.quantity * item.price).toFixed(2);
          row.innerHTML = `
            <td class="cart-item-image-cell">
              <img src="${imageUrl}" alt="${item.name}" class="cart-item-image" onerror="this.src='/images/logo.png'" />
            </td>
            <td class="cart-item-details-cell">${productDetails}</td>
            <td class="cart-item-quantity-total-cell">
              <div class="quantity-total-container">
                <div class="quantity-control">
                  <button class="quantity-btn decrease" data-index="${index}">-</button>
                  <span class="quantity-display">${item.quantity}</span>
                  <button class="quantity-btn increase" data-index="${index}">+</button>
                </div>
                <span class="cart-item-total">€${total}</span>
              </div>
            </td>
            <td class="cart-item-remove-cell">
              <button class="remove-btn" data-index="${index}">✕</button>
            </td>
          `;
          cartBody.appendChild(row);
        });

        // Add event listeners for quantity controls
        cartBody.querySelectorAll('.quantity-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
            const item = cart[index];

            if (e.target.classList.contains('increase')) {
              item.quantity += 1;
            } else if (e.target.classList.contains('decrease')) { // <-- FIXED: else if, not nested if
              if (item.quantity > 1) {
                item.quantity -= 1;
              }
            }

            sessionStorage.setItem('cart', JSON.stringify(cart));
            renderCheckoutCart();
            renderSubtotal();
          });
        });

        cartBody.querySelectorAll('.remove-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
            cart.splice(index, 1);
            sessionStorage.setItem('cart', JSON.stringify(cart));
            renderCheckoutCart();
            renderSubtotal();
          });
        });
      }

      // Render subtotal after cart update
      renderSubtotal();
    }

    // Function to handle special instructions
    function renderSpecialInstructions() {
      const instructionsTextarea = document.getElementById('order-instructions');
      if (instructionsTextarea) {
        // Load saved instructions
        const savedInstructions = sessionStorage.getItem('orderInstructions') || '';
        instructionsTextarea.value = savedInstructions;

        // Save instructions as the user types
        instructionsTextarea.addEventListener('input', () => {
          const instructions = instructionsTextarea.value.trim();
          if (instructions) {
            sessionStorage.setItem('orderInstructions', instructions);
          } else {
            sessionStorage.removeItem('orderInstructions');
          }
        });
      }
    }

    // Function to handle checkout button and popup function
    function setupCheckoutButton() { // <-- FIXED: was missing function keyword
      const checkoutBtn = document.querySelector('.checkout-btn');
      const popup = document.getElementById('checkout-popup');
      const closeButton = popup?.querySelector('.checkout-popup-close');

      if (checkoutBtn) {
        checkoutBtn.addEventListener('click', () => {
          const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
          if (cart.length > 0) {
            // Show popup
            if (popup) {
              popup.style.display = 'flex';
            }
          } else {
            alert('Your cart is empty. Add items before checking out.');
          }
        });
      }

      // Handle popup close
      if (closeButton) {
        closeButton.addEventListener('click', () => {
          popup.style.display = 'none';
        });
      }

      // Close popup when clicking outside
      if (popup) {
        popup.addEventListener('click', (event) => {
          if (event.target === popup) {
            popup.style.display = 'none';
          }
        });
      }
    }

    // Initial render
    renderCheckoutCart();
    renderSpecialInstructions();
    setupCheckoutButton();

    // Re-render if cart or instructions update
    window.addEventListener('storage', (e) => {
      if (e.key === 'cart' || e.key === 'orderInstructions') {
        renderCheckoutCart();
        renderSpecialInstructions();
      }
    });
  </script>
</body>
</html>